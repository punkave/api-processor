#!/usr/bin/env node

var program = require('commander'),
    fs = require('fs'),
    path = require('path'),
    nansen = require('../lib/nansen'),
    pjson = require('../package.json'),
    colors = require('colors');


var options = {};


var version = function(){
  console.log('\n\tnansen version '+ pjson.version);
}
var set = function(param, value) {
  options[param] = value;
}

program
  .usage('[options] <config_file>')
  .option('-v, --version', 'output of the version number', version)
  .option('-V, --verbose', 'Verbose Logging', function(){ set('verbose', true) })
  .option('-d --debug', 'Log debug info', function(){ set('debug', true) })
  .option('-p --parallel', 'Process Get and Post requests in Parallel', function(){ set('parallel', true) });


program.parse(process.argv);

if (process.argv.length <= 2) {
  program.help();

} else if (process.argv.length > 2){

  for(var i=2; i < process.argv.length; i++) {
    if (process.argv[i].indexOf('-') == 0) { continue; }
    try{
      var config = require(path.dirname(fs.realpathSync(process.argv[i])) + '/' + process.argv[i].split('/').pop());
      nansen.job(config, options);
    } catch(e){
      console.log(("\nError reading config file ").red + process.argv[i]);
      console.log("\n" + e + "\n");
    }
  }
  if (nansen.ready()) nansen.run();
}